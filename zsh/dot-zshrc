# Enable Powerlevel10k instant prompt
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

#!/bin/zsh

# Load environment variables from ~/.env if the file exists
if [ -f ~/.env ]; then
  export $(cat ~/.env | xargs)
fi


# Ensure baseline PATH so core utilities are available before any plugins
if ! command -v uname >/dev/null 2>&1; then
  export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
fi

# Safe mode: skip plugin managers and only load minimal config
if [[ -f "$HOME/.zsh_safe_mode" ]]; then
  echo "SAFE MODE: Loading minimal config..." >&2

  # Ensure baseline PATH first
  if ! command -v uname >/dev/null 2>&1; then
    export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:$PATH"
  fi

  if [[ -f "$HOME/.dotrc/config.zsh" ]]; then
    echo "SAFE MODE: Sourcing config.zsh" >&2
    source "$HOME/.dotrc/config.zsh"
  fi

  # Load aliases and other extras (but skip tui.zsh which has zinit calls)
  if [[ -f "$HOME/.dotrc/extra/aliases.zsh" ]]; then
    echo "SAFE MODE: Sourcing aliases.zsh" >&2
    source "$HOME/.dotrc/extra/aliases.zsh"
    echo "SAFE MODE: aliases.zsh loaded, checking l alias: $(type l 2>/dev/null | head -1)" >&2
  fi

  [[ -f "$HOME/.dotrc/extra/functions.zsh" ]] && source "$HOME/.dotrc/extra/functions.zsh"
  [[ -f "$HOME/.dotrc/extra/fzf.zsh" ]] && source "$HOME/.dotrc/extra/fzf.zsh"
  # Skip tui.zsh in safe mode as it has zinit calls

  # Set up minimal prompt and return
  echo "SAFE MODE: Setting prompt and returning" >&2
  PS1='%n@%m %~ %(!.#.$) '
  return
fi


# Hard-disable any lingering alias-tips hooks early to prevent preexec errors
disable_alias_tips() {
  typeset -f _alias_tips__preexec >/dev/null 2>&1 && unset -f _alias_tips__preexec
  typeset -f _alias_tips__precmd >/dev/null 2>&1 && unset -f _alias_tips__precmd
  typeset -p preexec_functions >/dev/null 2>&1 && preexec_functions=(${preexec_functions:#_alias_tips__preexec})
  typeset -p precmd_functions >/dev/null 2>&1 && precmd_functions=(${precmd_functions:#_alias_tips__precmd})
}
disable_alias_tips
precmd_functions=(disable_alias_tips ${precmd_functions[@]})


### Added by Zinit's installer
ZINIT_DIR="$HOME/.local/share/zinit"
ZINIT_HOME="$ZINIT_DIR/zinit.git"
if [[ ! -f $ZINIT_HOME/zinit.zsh ]]; then
    print -P "%F{33} %F{220}Installing %F{33}ZDHARMA-CONTINUUM%F{220} Initiative Plugin Manager (%F{33}zdharma-continuum/zinit%F{220})â€¦%f"
    command mkdir -p "$ZINIT_DIR" && command chmod g-rwX "$ZINIT_DIR"
    command git clone https://github.com/zdharma-continuum/zinit "$ZINIT_HOME" && \
        print -P "%F{33} %F{34}Installation successful.%f%b" || \
        print -P "%F{160} The clone has failed.%f%b"
fi

source "$ZINIT_HOME/zinit.zsh"
autoload -Uz _zinit
(( ${+_comps} )) && _comps[zinit]=_zinit

### End of Zinit's installer chunk

# Load .zsh_pre if available
[[ -f $HOME/.zsh_pre ]] && source $HOME/.zsh_pre
[[ -f $HOME/.dotrc/config.zsh ]] && source $HOME/.dotrc/config.zsh
[[ -f $HOME/.dotrc/extra/aliases.zsh ]] && source $HOME/.dotrc/extra/aliases.zsh
[[ -f $HOME/.dotrc/extra/functions.zsh ]] && source $HOME/.dotrc/extra/functions.zsh
[[ -f $HOME/.dotrc/extra/fzf.zsh ]] && source $HOME/.dotrc/extra/fzf.zsh
[[ -f $HOME/.localrc ]] && source $HOME/.localrc

ZSH_THEME="robbyrussell"

#####################
# PROMPT            #
#####################

zinit lucid from"gh-r" as"command" bpick'*apple-darwin.tar.gz' for \
   atload'eval "$(starship init zsh)"'    \
   starship/starship

#####################
# PROGRAMS          #
#####################

zinit ice bpick'*macos-arm64*' for jqlang/jq
zinit pack for ls_colors
zinit ice bpick'*apple-darwin*' \
    atload'eval "$(snm env zsh)"; alias n="snm"' \
    mv'snm* -> snm' pick'snm/snm' for @numToStr/snm

zinit ice bpick'*apple-darwin*' \
    atload'eval "$(zoxide init --no-aliases zsh)"; alias z="__zoxide_z"' \
    pick'zoxide/zoxide' for @ajeetdsouza/zoxide

zinit ice bpick'*darwin_arm64*' for @junegunn/fzf

zinit ice bpick'rg/rg' mv'ripgrep* -> rg' for @BurntSushi/ripgrep

zinit ice bpick'fd/fd' mv'fd* -> fd' for @sharkdp/fd

zinit ice bpick'bat/bat' mv'bat* -> bat' \
    atload'export MANPAGER="bat --plain"' for @sharkdp/bat

zinit ice bpick'delta/delta' mv'delta* -> delta' for @dandavison/delta

zinit ice bpick'*apple-darwin*' \
    atload'alias l="eza -abghHlS --git --group-directories-first"' \
    for @eza-community/eza
#
zinit ice bpick'*macos-aarch64*' for @JohnnyMorganz/StyLua

zinit ice bpick'gitui-mac.tar.gz' for @extrawurst/gitui



##########################
# OMZ Libs and Plugins   #
##########################

setopt promptsubst

zinit wait lucid for \
	OMZL::clipboard.zsh \
	OMZL::compfix.zsh \
	OMZL::completion.zsh \
	OMZL::correction.zsh \
    atload'
        alias ..="cd .."
        alias ...="cd ../.."
        alias ....="cd ../../.."
        alias .....="cd ../../../.."

        function take() {
            mkdir -p $@ && cd ${@:$#}
        }

        alias rm="rm -rf"
    ' \
	OMZL::directories.zsh \
	OMZL::git.zsh \
	OMZL::grep.zsh \
	OMZL::key-bindings.zsh \
	OMZL::spectrum.zsh \
	OMZL::functions.zsh \
	OMZL::termsupport.zsh \
    atload"
        alias gcd='git checkout dev'
        alias gce='git commit -a -e'
    " \
	OMZP::git \
  # djui/alias-tips \
  # https://github.com/junegunn/fzf/blob/master/shell/key-bindings.zsh \
  # https://github.com/junegunn/fzf/blob/master/shell/completion.zsh \
    # hlissner/zsh-autopair \  # Plugin not available, commented out
    # chriskempson/base16-shell \  # Plugin not available, commented out
	# OMZP::fzf \  # Plugin causing issues, commented out

#####################
# PLUGINS           #
#####################
# @source: https://github.com/crivotz/dot_files/blob/master/linux/zplugin/zshrc

# IMPORTANT:
# These plugins should be loaded after ohmyzsh plugins
zinit wait lucid for \
    reset \
    zdharma-continuum/fast-syntax-highlighting \
    trapd00r/LS_COLORS

#####################
# MANUAL CONFIG     #
#####################


if command -v fnm >/dev/null 2>&1; then
  eval "$(fnm env)"
fi

# nvm
if [ -s "${HOME}/.nvm/nvm.sh" ]; then
  export NVM_DIR="${HOME}/.nvm"
  \. "$NVM_DIR/nvm.sh" # This loads nvm
elif [ -n "${XDG_CONFIG_HOME-}" ] && [ -s "${XDG_CONFIG_HOME}/nvm/nvm.sh" ]; then
  export NVM_DIR="${XDG_CONFIG_HOME}/nvm"
  \. "$NVM_DIR/nvm.sh" # This loads nvm
fi

# Ensure alias-tips hooks are removed if previously installed
typeset -f _alias_tips__preexec >/dev/null 2>&1 && unset -f _alias_tips__preexec
typeset -f _alias_tips__precmd >/dev/null 2>&1 && unset -f _alias_tips__precmd

autoload -Uz compinit
compinit

# bun completions
[ -s "/Users/jb/.bun/_bun" ] && source "/Users/jb/.bun/_bun"

# The following lines have been added by Docker Desktop to enable Docker CLI completions.
fpath=(/Users/jb/.docker/completions $fpath)
# End of Docker CLI completions

# Added by Windsurf
export PATH="/Users/jb/.codeium/windsurf/bin:$PATH"

PATH=~/.console-ninja/.bin:$PATH

[[ "$TERM_PROGRAM" == "kiro" ]] && . "$(kiro --locate-shell-integration-path zsh)"

alias claude="/Users/jb/.claude/local/claude"
